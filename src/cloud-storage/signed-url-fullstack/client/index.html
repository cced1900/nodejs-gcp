<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Upload</title>
  </head>
  <body>
    <h1>Upload to cloud storage using signed url</h1>
    <form id="upload-form">
      <input type="file" accept="image/*" name="file" id="upload-input" />
      <button type="submit">Upload</button>
    </form>
    <script>
      (function() {
        window.onload = onload;

        const API = {
          backendURL: 'http://localhost:3000',
          getSignedUrl(filename) {
            const url = new URL(`${API.backendURL}/signed-url`);
            const params = { filename };
            url.search = new URLSearchParams(params);
            return fetch(url).then((res) => res.json());
          },
          upload(signedUrl, file) {
            return fetch(signedUrl, {
              method: 'PUT',
              headers: {
                'Access-Control-Request-Method': 'PUT'
              },
              body: file
            }).then((res) => {
              console.log('upload success');
              console.log('res: ', res);
            });
          },

          xhrUpload(signedUrl, file) {
            return new Promise((resolve, reject) => {
              const xhr = new XMLHttpRequest();
              xhr.open('PUT', signedUrl, true);
              xhr.onload = (xhr) => {
                const status = xhr.status;
                if (status === 200) {
                  resolve(xhr);
                } else {
                  reject('Something went wrong!');
                }
              };

              xhr.onerror = (error) => {
                reject('Something went wrong');
              };
              xhr.setRequestHeader('Content-Type', file.type);
              xhr.send(file);
            });
          }
        };

        function onload() {
          const uploadFormElement = document.getElementById('upload-form');
          uploadFormElement.addEventListener('submit', handleSubmit, false);

          function handleSubmit(event) {
            event.preventDefault();
            const fileInputElement = document.getElementById('upload-input');
            const files = fileInputElement.files;
            if (files.length) {
              const file = files[0];
              console.log(file);
              API.getSignedUrl(file.name)
                .then((getSignedUrlResponse) => {
                  console.log('getSignedUrlResponse: ', getSignedUrlResponse);
                  return getSignedUrlResponse.signedUrl;
                })
                .then((signedUrl) => {
                  return API.upload(signedUrl, file);
                })
                .catch((err) => {
                  console.log(err);
                });
            }
          }
        }
      })();
    </script>
  </body>
</html>
